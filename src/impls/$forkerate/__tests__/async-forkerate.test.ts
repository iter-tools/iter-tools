/**
 * @generated-from ./$forkerate.test.ts
 * This file is autogenerated from a template. Please do not edit it directly.
 * To rebuild it from its template use the command
 * > npm run generate
 * More information can be found in CONTRIBUTING.md
 */

import { asyncForkerate, asyncStartsWithSeq, asyncStr } from 'iter-tools-es';
import { asyncWrap, asyncUnwrap } from '../../../test/async-helpers.js';

describe('asyncForkerate', () => {
  describe('forkerator', () => {
    it('yields values from source', async () => {
      expect(await asyncUnwrap((await asyncForkerate(asyncWrap([1, 2, 3]))).asIterator())).toEqual([
        1,
        2,
        3,
      ]);
    });
  });

  describe('fork', () => {
    it('yields values including and after forkr.current', async () => {
      const forkr = await asyncForkerate(asyncWrap([1, 2, 3]));

      expect(await asyncUnwrap(forkr.fork())).toEqual([1, 2, 3]);
      expect(await asyncUnwrap(forkr.fork())).toEqual([1, 2, 3]);

      await forkr.advance();

      expect(await asyncUnwrap(forkr.fork())).toEqual([2, 3]);
      expect(await asyncUnwrap(forkr.fork())).toEqual([2, 3]);

      await forkr.advance();

      expect(await asyncUnwrap(forkr.fork())).toEqual([3]);
      expect(await asyncUnwrap(forkr.fork())).toEqual([3]);

      await forkr.advance();

      expect(await asyncUnwrap(forkr.fork())).toEqual([]);
      expect(await asyncUnwrap(forkr.fork())).toEqual([]);

      expect(await forkr.fork().next()).toEqual({ value: undefined, done: true });
    });
  });

  it('can be used to strip comments', async () => {
    expect(
      await asyncStr(
        (async function* stripComments(source) {
          let forkr = await asyncForkerate(source);

          while (true) {
            const isComment = await asyncStartsWithSeq('//', forkr.fork());

            while (!forkr.done && forkr.value !== '\n') {
              if (!isComment) yield forkr.value;
              forkr = await forkr.advance();
            }

            if (forkr.done) break;

            if (!isComment) yield '\n';
            forkr = await forkr.advance();
          }
        })('// comment\ncode'),
      ),
    ).toBe('code');
  });
});
