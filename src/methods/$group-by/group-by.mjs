/**
 * @generated-from ./$group-by.js
 * This file is autogenerated from a template. Please do not edit it directly.
 * To rebuild it from its template use the command
 * > npm run generate
 * More information can be found in CONTRIBUTING.md
 */

import { iterableCurry } from '../../internal/iterable';
import { PartsIterator, Spliterator, split } from '../../internal/spliterator';
let warnedNullGetKeyDeprecation = false;

const warnNullGetKeyDeprecation = () => {
  if (!warnedNullGetKeyDeprecation) {
    console.warn(
      `\`${'groupBy'}(null, iterable)\` is deprecated and will be removed in iter-tools@8. ` +
        `Instead use ${'group'}(iterable)`,
    );
    warnedNullGetKeyDeprecation = true;
  }
};

class GroupingSpliterator extends Spliterator {
  constructor(sourceIterator, getKey) {
    super(sourceIterator);
    this.getKey = getKey;
    this.key = undefined;
    this.item = null;
    this.idx = 0;
  }

  static nullOrInstance(sourceIterator, getKey) {
    const inst = new GroupingSpliterator(sourceIterator, getKey);
    return inst._isEmpty() ? null : inst;
  }

  _isEmpty() {
    this.buffer();
    return this.item.done;
  }

  buffer() {
    const { key } = this;

    if (this.item === null) {
      this.item = super.next();
      const { done, value } = this.item;

      if (!done) {
        this.key = this.getKey(value, this.idx++);
      }
    }

    return this.key !== key;
  }

  next() {
    const newGroup = this.buffer();

    if (this.item.done) {
      return {
        value: undefined,
        done: true,
      };
    } else {
      const { value } = this.item;

      if (!newGroup) {
        this.item = null;
      }

      return {
        value: newGroup ? split : value,
        done: false,
      };
    }
  }
}

class GroupPartsIterator extends PartsIterator {
  next() {
    const item = super.next();

    if (!item.done) {
      this.spliterator.buffer();
      return {
        value: [this.spliterator.key, item.value],
        done: false,
      };
    } else {
      return item;
    }
  }
}

export function* groupBy(source, getKey) {
  if (getKey === null) {
    warnNullGetKeyDeprecation();
  }

  yield* new GroupPartsIterator(
    GroupingSpliterator.nullOrInstance(
      source[Symbol.iterator](),
      getKey === null ? _ => _ : getKey,
    ),
  );
}
export default iterableCurry(groupBy);
